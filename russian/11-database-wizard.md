# Мастер базы данных

## Назначение

Модуль «Мастер базы данных» предназначен для выполнения следующих операций:

* проверка базы данных
* работа с резервными копиями
* импорт и экспорт данных

## Проверка базы данных

Процедуру проверки базы данных рекомендуется выполнять не реже, чем раз в месяц. При выполнении проверки базы данных работу остальных модулей можно не прекращать. По завершении проверки рекомендуется перезапустить модуль «Дежурный оператор».

## Резервное копирование

Резервное копирование базы данных можно выполнять только на том компьютере, на котором выполнялась полная установка «Центра охраны».

Процедура резервного копирования не оказывает критического влияния на работу других модулей «Центра охраны». Тем не менее, при выполнении резервного копирования базы данных, возможно некоторое снижение производительности системы в целом: это нужно принимать во внимание при выборе времени для выполнения резервного копирования.

При создании резервной копии базы данных нужно выбрать объем копируемой информации. 

* Полная копия базы данных содержит всю информацию, хранящуюся в базе данных на момент копирования, включая полученные события, действия операторов и отправленные SMS-сообщения за все время эксплуатации программного обеспечения.

* Объем данных в оперативной копии значительно меньше: в ней сохраняются события, действия операторов и SMS-сообщения только за последний месяц.

Исходя из объема сохраняемой при резервном копировании информации, рекомендуется полное резервное копирование выполнять не реже, чем один раз в месяц, а оперативное резервное копирование — не реже одного раза в сутки.

Для хранения резервных копий рекомендуется использовать один, а лучше — несколько носителей информации, причем таких, которые физически не связаны с дисковой подсистемой компьютера, на котором хранится база данных «Центра охраны». Например, это может быть отдельный жесткий диск, флеш-накопитель или сетевой ресурс. Необходимо отметить, что при настройке резервного копирования можно указать несколько путей, по которым будет сохранена резервная копия.

Для того, чтобы увеличить надежность системы в целом, «Центр охраны» выполняет автоматическое резервное копирование. Оперативные копии базы данных сохраняются в папке `ANDROMEDA DATA\SYSBACKUP`, интервал создания автоматических резервных копий по умолчанию — 24 часа.

## Восстановление из резервной копии

Восстановление базы данных из резервной копии можно выполнять только на том компьютере, на который выполнялась полная установка программного обеспечения «Центр охраны». 

Перед тем, как приступить к восстановлению базы данных из резервной копии, необходимо остановить работу всех модулей «Центра охраны» включая модуль «Менеджер событий».

Версия базы данных, из которой производится восстановление, не имеет значения: сразу после восстановления модуль «Мастер базы данных» проверит версию восстановленных данных и, при необходимости, выполнит обновление.

Для того чтобы сразу после восстановления базы данных из резервной копии не началась генерация событий об отсутствии контрольного события, нужно при восстановлении базы данных из резервной копии указать необходимость установить для объектов текущее время, как время приема последнего события.

Восстановление базы данных рекомендуется производить в два этапа: сначала выполнить восстановление из самой свежей полной копии базы данных, а после этого — из актуальной оперативной копии. Таким образом, на первом этапе будет восстановлена вся имеющаяся история, а на втором этапе будет актуализирована постоянно изменяющаяся информация.

По завершению обоих этапов восстановления базы данных из резервной копии рекомендуется выполнить проверку базы данных. При этом необходимо помнить, что процедура проверки базы данных не блокирует работу других модулей «Центра охраны», поэтому ее можно выполнять после того, как будут запущены «Менеджер событий» и «Дежурный оператор».

## Импорт данных

Программное обеспечение «Центр охраны» поддерживает импорт данных из следующих источников:

* база данных программного обеспечения «Андромеда» версий 2.0 — 2.76
* база данных программного обеспечения «Андромеда Либерти»
* база данных программного обеспечения «Страж»
* база данных программного обеспечения «CSM32»

Импорт данных можно выполнять только на том компьютере, на который выполнялась полная установка программного обеспечения «Центр охраны». 

Перед тем, как приступить к импорту данных, необходимо остановить работу всех модулей «Центра охраны», включая модуль «Менеджер событий».

### Импорт из «Андромеды» версии 2.0 — 2.76 и «Андромеды Либерти»

Если предполагается импорт данных из программного обеспечения «Андромеда» версии 2.0 — 2.76 или «Андромеда Либерти», то при установке «Центра охраны» нужно указать необходимость установки `BDE` — именно эта подсистема используется для доступа к данным этих программ.

При выполнении импорта данных из базы данных программного обеспечения «Андромеда» можно перенести не только описание объектов и связанную информацию, но и полученные события и действия операторов.

Если в базе данных, из которой выполняется импорт, содержатся события за несколько лет, то импорт событий и действий операторов может занять весьма продолжительное время. В этом случае процедуру импорта рекомендуется разбить на два этапа: сначала импортировать системную информацию и события за последний месяц, после этого запустить модуль «Менеджер событий», и уже приступив к работе с 

«Центром охраны» выполнить импорт оставшихся событий и действий оператора. 
События и действия всегда импортируются за целый месяц, несмотря на то, что при настройке импорта можно задать дату с точностью до дня.

При выполнении импорта из базы данных «Андромеды» версии 2.0 — 2.76 доступна функция сдвига номеров объектов. Суть функции заключается в том, что к номерам объектов, информация о которых переносится в «Центр охраны», будет добавлено слагаемое, указанное при настройке процедуры импорта. 

Если используется сдвиг и процедура импорта разбита на два этапа, то настройки сдвига необходимо указывать и на первом, и на втором этапе, хотя во время второго этапа переносятся только события и действия операторов.

Сдвиг номеров объектов может быть полезен, если происходит объединение нескольких баз данных в одну, например — при объединении нескольких пультов.

Для того, чтобы сразу после импорта данных не началась генерация событий об отсутствии контрольного события, нужно при настройке импорта указать необходимость установить для объектов текущее время, как время приема последнего события.

### Импорт из «Стража»

Если предполагается импорт описаний объектов из программного обеспечения «Страж», то на компьютере на время операции импорта должен быть установлен Microsoft Access 2003 или более новый. 

Можно установить «Центр охраны» на компьютер с программным обеспечением «Страж», выполнить импорт и перенести данные «Центра охраны» с помощью резервной копии.

При выполнении импорта из программного обеспечения «Страж» необходимо указать папку, в которой находятся файлы базы данных этого программного обеспечения. Если к «Стражу» была подключена станция «Lonta-202» («RS-202»), то для выполнения импорта требуется два файла — «Guard.mdb» и «SurGuard_code.mdb». Если же использовалась только станция «RS-200», то для выполнения импорта достаточно файла «Guard.mdb».

В настройках операции импорта из «Стража» можно указать номера или интервалы номеров объектов, описания которых нужно перенести в «Центр охраны». Таким образом, можно выполнить импорт описаний не всех, а только части объектов — тех, которых нужно.

При выполнении импорта из базы данных программного обеспечения «Страж» можно сдвинуть номера импортируемых объектов. Суть сдвига заключается в том, что к номерам объектов, информация о которых переносится в «Центр охраны», будет добавлено слагаемое, указанное при настройке процедуры импорта. 

Точно такая же функция доступна при настройке приема событий от пультов «RS-200» и «Lonta-202». Таким образом, сдвинув номера объектов можно организовать работу программного обеспечения «Центр охраны» с несколькими пультами одного или разных производителей.

При импорте из «Стража» поддерживаются все особенности описания объектов, используемых в этом программном обеспечении, включая возможность описать несколько объектов в качестве разделов одного передатчика. 
Импорт из «CSM32»

Если предполагается импорт описаний объектов из программного обеспечения «CSM32», то на компьютере на время операции импорта должен быть установлен Microsoft Access 2003 или более новый. 

Можно установить «Центр охраны» на компьютер с программным обеспечением «CSM32», выполнить импорт и перенести данные «Центра охраны» с помощью резервной копии.

При выполнении импорта из программного обеспечения «CSM32» необходимо указать путь к файлу «Main.mdb», в котором хранятся данные программного обеспечения «CSM32».
Для того, чтобы перенести как можно более полное описание объектов, при настройке импорта из «CSM32» необходимо указать соответствие классов событий, используемых в «CSM32» типам классов событий «Центра охраны».

## Экспорт данных

Программное обеспечение «Центр охраны» поддерживает экспорт информации об объектах в текстовый файл с разделителями значений.

При выполнении экспорта необходимо выбрать объекты и поля (столбцы), информация о которых будет записана в файл экспорта.

Кроме того, необходимо указать имя файла, в который будет произведен экспорт, а также символ, который будет использоваться в качестве разделителя значений.

## Параметры командной строки

Наряду с графическим интерфейсом пользователя модуль «Мастер базы данных» обладает возможностью управления с помощью параметров командной строки. 

Эта возможность может быть полезной в том случае, если в качестве планировщика заданий создания резервной копии базы данных или восстановления из резервной копии используется планировщик Windows, который обладает более развитыми возможностями, нежели планировщик, встроенный в модуль «Менеджер событий».

### Создание резервной копии базы данных

	AnDBWiz.exe 
		/BACKUPDB 
		/FOLDER:<Папка назначения 1>;<Папка назначения 2> 
		/TYPE:<Тип резервной копии> 
		/BACKUPCOUNT:<Количество файлов в папке назначения>

	/BACKUPDB
	
Данный параметр указывает, что модуль «Мастер базы данных» должен выполнить резервное копирование базы данных. Настройки процедуры резервного копирования задаются следующими за ним параметрами командной строки.

	/FOLDER:<Папка назначения 1>;<Папка назначения 2>
	
Одна или несколько папок, в которые будет помещена резервная копия базы данных. Должна быть указана, по крайней мере, одна папка. Названия папок должны быть заключены в кавычки. Если указывается несколько папок, то они должны быть разделены символом «точка с запятой». Допускается использование в названиях папок абсолютных путей.

	/TYPE:<Тип резервной копии>

Тип резервной копии, которую необходимо создать. Значение «0» для данного параметра соответствует необходимости создания оперативной резервной копии. Значение «1» означает, что нужно создать полную резервную копию базы данных. Параметр не является обязательным. Если значение параметра не задано, то будет создана оперативная резервная копия.

	/BACKUPCOUNT:<Количество файлов в папке назначения>

Данный параметр определяет максимально возможное количество файлов резервной копии базы данных в папке назначения. Если при создании резервной копии будет обнаружено, что количество файлов резервных копий такого же типа превышает максимально возможное, то самый старый по времени файл резервной копии будет удален. Параметр не является обязательным. Если значение параметра не задано, то в качестве значения для этого параметра будет использоваться значение 10.

### Восстановление базы данных из резервной копии

	AnDBWiz.exe 
		/RESTOREDB 
		/FOLDER:<Исходная папка> 
		/TYPE:<Тип резервной копии>

	/RESTOREDB

Данный параметр указывает, что модуль «Мастер базы данных» должен выполнить восстановление базы данных из резервной копии. Настройки процедуры восстановления базы данных задаются следующими за ним параметрами командной строки.

	/FOLDER:<Исходная папка>

Папка, в которой будет произведен поиск резервной копии базы данных, из которой будет выполнено восстановление. Если в указанной папке будет обнаружено несколько файлов резервной копии заданного типа, то будет произведено восстановление из самого нового по времени создания файла.

	/TYPE:<Тип резервной копии>

Тип резервной копии, из которой необходимо выполнить восстановление. Значение «0» для данного параметра соответствует необходимости восстановления из оперативной резервной копии. Значение «1» означает, что нужно восстановить базу данных из полной резервной копии. Параметр не является обязательным. Если значение параметра не задано, то будет выполнено восстановление из оперативной резервной копии.

### Пример использования параметров командной строки

	AnDBWiz.exe 
		/BACKUPDB 
		/FOLDER:"E:\Backup Data\Operational";"\\Storage\Andromeda Backup\Operational" 
		/BACKUPCOUNT:25

Приведенный набор параметров командной строки означает, что модуль «Мастер базы данных» должен создать оперативную копию базы данных и скопировать ее в папки `E:\Backup Data\Operational` и `\\Storage\Andromeda Backup\Operational`. 

При копировании резервной копии в папку назначения модуль «Мастер базы данных» должен проверить, что общее количество файлов оперативной резервной копии в папке назначения не превышает 24, а если их больше, то самый старый по времени создания файл резервной копии должен быть удален.

